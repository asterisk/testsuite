testinfo:
    summary:     'Tests HEP with PJSIP'
    description: |
        This test validates Asterisk sending RTCP information encoded
        in JSON over the Homer Encapsulation Protocol (HEP). The
        test runs a basic call using Asterisk's PJSIP stack. One end
        of the call plays a sound file (tt-monkeys) while the other
        end echos back the sound it receives. This results in SR packets
        being generated by both Asterisk instances. The test verifies
        that both Asterisk instances send their respective RTCP packets
        to HEP (both what they sent and what they received).

test-modules:
    test-object:
        config-section: test-object-config
        typename: 'test_case.TestCaseModule'
    modules:
        -
            typename: 'pluggable_modules.Originator'
            config-section: originator-config
        -
            typename: 'hep_capture_node.HEPCaptureNode'
            config-section: hep-node-config-ast1
        -
            typename: 'hep_capture_node.HEPCaptureNode'
            config-section: hep-node-config-ast2
        -
            config-section: 'hangup-monitor'
            typename: 'pluggable_modules.HangupMonitor'

test-object-config:
    asterisk-instances: 2
    connect-ami: True

hangup-monitor:
    ids: '0'

originator-config:
    channel: 'Local/1000@default'
    exten: 'playback'
    context: 'default'
    priority: 1
    async: True
    trigger: 'ami_connect'
    async: True

hep-node-config-ast1:
    bind-port: 9998
    match-any: True
    packet-blacklist:
        - 'SIP'
    packets:
        -
            ip_family: 2
            uuid: 'PJSIP/ast2-00000000'
            # See http://blogs.msdn.com/b/oldnewthing/archive/2006/05/22/603788.aspx
            # for why this is a terrible idea. Really, all we care about is that:
            # (a) we have something in the src/dst addr fields
            # (b) that something is not 0.0.0.0
            src_addr: '^(.(?!0.0.0.0))*'
            dst_addr: '^(.(?!0.0.0.0))*'
            protocol_type: 5
            capture_agent_id: 1
            ip_id: 17
            payload:
                decode: 'RTCP'
                value:
                    { ssrc: "\\d.*",
                      type: 200,
                      sender_information: { ntp_timestamp_sec: "\\d.*",
                                            packets: "\\d.*",
                                            ntp_timestamp_usec: "\\d.*",
                                            octets: "\\d.*",
                                            rtp_timestamp: "\\d.*", },
                      report_blocks:[ { source_ssrc: "\\d.*",
                                        highest_seq_no: "\\d.*",
                                        fraction_lost: 0,
                                        ia_jitter: "\\d.*",
                                        packets_lost: 0,
                                        lsr: "\\d.*",
                                        dlsr: "\\d.*" }, ],
                      report_count: 1,
                    }
        -
            ip_family: 2
            uuid: 'PJSIP/ast2-00000000'
            src_addr: '^(.(?!0.0.0.0))*'
            dst_addr: '^(.(?!0.0.0.0))*'
            protocol_type: 5
            capture_agent_id: 1
            ip_id: 17
            payload:
                decode: 'RTCP'
                value:
                    { ssrc: "\\d.*",
                      type: 200,
                      sender_information: { ntp_timestamp_sec: "\\d.*",
                                            packets: "\\d.*",
                                            ntp_timestamp_usec: "\\d.*",
                                            octets: "\\d.*",
                                            rtp_timestamp: "\\d.*", },
                      report_blocks:[ { source_ssrc: "\\d.*",
                                        highest_seq_no: "\\d.*",
                                        fraction_lost: 0,
                                        ia_jitter: "\\d.*",
                                        packets_lost: 0,
                                        lsr: "\\d.*",
                                        dlsr: "\\d.*" }, ],
                      report_count: 1,
                    }
        -
            ip_family: 2
            uuid: 'PJSIP/ast2-00000000'
            src_addr: '^(.(?!0.0.0.0))*'
            dst_addr: '^(.(?!0.0.0.0))*'
            protocol_type: 5
            capture_agent_id: 1
            ip_id: 17
            payload:
                decode: 'RTCP'
                value:
                    { ssrc: "\\d.*",
                      type: 200,
                      sender_information: { ntp_timestamp_sec: "\\d.*",
                                            packets: "\\d.*",
                                            ntp_timestamp_usec: "\\d.*",
                                            octets: "\\d.*",
                                            rtp_timestamp: "\\d.*", },
                      report_blocks:[ { source_ssrc: "\\d.*",
                                        highest_seq_no: "\\d.*",
                                        fraction_lost: 0,
                                        ia_jitter: "\\d.*",
                                        packets_lost: 0,
                                        lsr: "\\d.*",
                                        dlsr: "\\d.*" }, ],
                      report_count: 1,
                    }
        -
            ip_family: 2
            uuid: 'PJSIP/ast2-00000000'
            src_addr: '^(.(?!0.0.0.0))*'
            dst_addr: '^(.(?!0.0.0.0))*'
            protocol_type: 5
            capture_agent_id: 1
            ip_id: 17
            payload:
                decode: 'RTCP'
                value:
                    { ssrc: "\\d.*",
                      type: 200,
                      sender_information: { ntp_timestamp_sec: "\\d.*",
                                            packets: "\\d.*",
                                            ntp_timestamp_usec: "\\d.*",
                                            octets: "\\d.*",
                                            rtp_timestamp: "\\d.*", },
                      report_blocks:[ { source_ssrc: "\\d.*",
                                        highest_seq_no: "\\d.*",
                                        fraction_lost: 0,
                                        ia_jitter: "\\d.*",
                                        packets_lost: 0,
                                        lsr: "\\d.*",
                                        dlsr: "\\d.*" }, ],
                      report_count: 1,
                    }
        -
            ip_family: 2
            uuid: 'PJSIP/ast2-00000000'
            src_addr: '^(.(?!0.0.0.0))*'
            dst_addr: '^(.(?!0.0.0.0))*'
            protocol_type: 5
            capture_agent_id: 1
            ip_id: 17
            payload:
                decode: 'RTCP'
                value:
                    { ssrc: "\\d.*",
                      type: 200,
                      sender_information: { ntp_timestamp_sec: "\\d.*",
                                            packets: "\\d.*",
                                            ntp_timestamp_usec: "\\d.*",
                                            octets: "\\d.*",
                                            rtp_timestamp: "\\d.*", },
                      report_blocks:[ { source_ssrc: "\\d.*",
                                        highest_seq_no: "\\d.*",
                                        fraction_lost: 0,
                                        ia_jitter: "\\d.*",
                                        packets_lost: 0,
                                        lsr: "\\d.*",
                                        dlsr: "\\d.*" }, ],
                      report_count: 1,
                    }
        -
            ip_family: 2
            uuid: 'PJSIP/ast2-00000000'
            src_addr: '^(.(?!0.0.0.0))*'
            dst_addr: '^(.(?!0.0.0.0))*'
            protocol_type: 5
            capture_agent_id: 1
            ip_id: 17
            payload:
                decode: 'RTCP'
                value:
                    { ssrc: "\\d.*",
                      type: 200,
                      sender_information: { ntp_timestamp_sec: "\\d.*",
                                            packets: "\\d.*",
                                            ntp_timestamp_usec: "\\d.*",
                                            octets: "\\d.*",
                                            rtp_timestamp: "\\d.*", },
                      report_blocks:[ { source_ssrc: "\\d.*",
                                        highest_seq_no: "\\d.*",
                                        fraction_lost: 0,
                                        ia_jitter: "\\d.*",
                                        packets_lost: 0,
                                        lsr: "\\d.*",
                                        dlsr: "\\d.*" }, ],
                      report_count: 1,
                    }

hep-node-config-ast2:
    bind-port: 9999
    match-any: True
    packet-blacklist:
        - 'SIP'
    packets:
        -
            ip_family: 2
            uuid: 'PJSIP/ast1-00000000'
            # See http://blogs.msdn.com/b/oldnewthing/archive/2006/05/22/603788.aspx
            # for why this is a terrible idea. Really, all we care about is that:
            # (a) we have something in the src/dst addr fields
            # (b) that something is not 0.0.0.0
            src_addr: '^(.(?!0.0.0.0))*'
            dst_addr: '^(.(?!0.0.0.0))*'
            protocol_type: 5
            capture_agent_id: 2
            ip_id: 17
            payload:
                decode: 'RTCP'
                value:
                    { ssrc: "\\d.*",
                      type: 200,
                      sender_information: { ntp_timestamp_sec: "\\d.*",
                                            packets: "\\d.*",
                                            ntp_timestamp_usec: "\\d.*",
                                            octets: "\\d.*",
                                            rtp_timestamp: "\\d.*", },
                      report_blocks:[ { source_ssrc: "\\d.*",
                                        highest_seq_no: "\\d.*",
                                        fraction_lost: 0,
                                        ia_jitter: "\\d.*",
                                        packets_lost: 0,
                                        lsr: "\\d.*",
                                        dlsr: "\\d.*" }, ],
                      report_count: 1,
                    }
        -
            ip_family: 2
            uuid: 'PJSIP/ast1-00000000'
            src_addr: '^(.(?!0.0.0.0))*'
            dst_addr: '^(.(?!0.0.0.0))*'
            protocol_type: 5
            capture_agent_id: 2
            ip_id: 17
            payload:
                decode: 'RTCP'
                value:
                    { ssrc: "\\d.*",
                      type: 200,
                      sender_information: { ntp_timestamp_sec: "\\d.*",
                                            packets: "\\d.*",
                                            ntp_timestamp_usec: "\\d.*",
                                            octets: "\\d.*",
                                            rtp_timestamp: "\\d.*", },
                      report_blocks:[ { source_ssrc: "\\d.*",
                                        highest_seq_no: "\\d.*",
                                        fraction_lost: 0,
                                        ia_jitter: "\\d.*",
                                        packets_lost: 0,
                                        lsr: "\\d.*",
                                        dlsr: "\\d.*" }, ],
                      report_count: 1,
                    }
        -
            ip_family: 2
            uuid: 'PJSIP/ast1-00000000'
            src_addr: '^(.(?!0.0.0.0))*'
            dst_addr: '^(.(?!0.0.0.0))*'
            protocol_type: 5
            capture_agent_id: 2
            ip_id: 17
            payload:
                decode: 'RTCP'
                value:
                    { ssrc: "\\d.*",
                      type: 200,
                      sender_information: { ntp_timestamp_sec: "\\d.*",
                                            packets: "\\d.*",
                                            ntp_timestamp_usec: "\\d.*",
                                            octets: "\\d.*",
                                            rtp_timestamp: "\\d.*", },
                      report_blocks:[ { source_ssrc: "\\d.*",
                                        highest_seq_no: "\\d.*",
                                        fraction_lost: 0,
                                        ia_jitter: "\\d.*",
                                        packets_lost: 0,
                                        lsr: "\\d.*",
                                        dlsr: "\\d.*" }, ],
                      report_count: 1,
                    }
        -
            ip_family: 2
            uuid: 'PJSIP/ast1-00000000'
            src_addr: '^(.(?!0.0.0.0))*'
            dst_addr: '^(.(?!0.0.0.0))*'
            protocol_type: 5
            capture_agent_id: 2
            ip_id: 17
            payload:
                decode: 'RTCP'
                value:
                    { ssrc: "\\d.*",
                      type: 200,
                      sender_information: { ntp_timestamp_sec: "\\d.*",
                                            packets: "\\d.*",
                                            ntp_timestamp_usec: "\\d.*",
                                            octets: "\\d.*",
                                            rtp_timestamp: "\\d.*", },
                      report_blocks:[ { source_ssrc: "\\d.*",
                                        highest_seq_no: "\\d.*",
                                        fraction_lost: 0,
                                        ia_jitter: "\\d.*",
                                        packets_lost: 0,
                                        lsr: "\\d.*",
                                        dlsr: "\\d.*" }, ],
                      report_count: 1,
                    }
        -
            ip_family: 2
            uuid: 'PJSIP/ast1-00000000'
            src_addr: '^(.(?!0.0.0.0))*'
            dst_addr: '^(.(?!0.0.0.0))*'
            protocol_type: 5
            capture_agent_id: 2
            ip_id: 17
            payload:
                decode: 'RTCP'
                value:
                    { ssrc: "\\d.*",
                      type: 200,
                      sender_information: { ntp_timestamp_sec: "\\d.*",
                                            packets: "\\d.*",
                                            ntp_timestamp_usec: "\\d.*",
                                            octets: "\\d.*",
                                            rtp_timestamp: "\\d.*", },
                      report_blocks:[ { source_ssrc: "\\d.*",
                                        highest_seq_no: "\\d.*",
                                        fraction_lost: 0,
                                        ia_jitter: "\\d.*",
                                        packets_lost: 0,
                                        lsr: "\\d.*",
                                        dlsr: "\\d.*" }, ],
                      report_count: 1,
                    }
        -
            ip_family: 2
            uuid: 'PJSIP/ast1-00000000'
            src_addr: '^(.(?!0.0.0.0))*'
            dst_addr: '^(.(?!0.0.0.0))*'
            protocol_type: 5
            capture_agent_id: 2
            ip_id: 17
            payload:
                decode: 'RTCP'
                value:
                    { ssrc: "\\d.*",
                      type: 200,
                      sender_information: { ntp_timestamp_sec: "\\d.*",
                                            packets: "\\d.*",
                                            ntp_timestamp_usec: "\\d.*",
                                            octets: "\\d.*",
                                            rtp_timestamp: "\\d.*", },
                      report_blocks:[ { source_ssrc: "\\d.*",
                                        highest_seq_no: "\\d.*",
                                        fraction_lost: 0,
                                        ia_jitter: "\\d.*",
                                        packets_lost: 0,
                                        lsr: "\\d.*",
                                        dlsr: "\\d.*" }, ],
                      report_count: 1,
                    }

properties:
    minversion: '12.5.0'
    dependencies:
        - asterisk : 'res_pjsip'
        - asterisk: 'res_hep'
        - asterisk: 'res_hep_rtcp'
        - python: 'json'
        - python: 'construct'

