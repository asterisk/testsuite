; Tests an inbound call and an outbound, checking headers for each to
; make sure PJSIP_HEADER does what it is supposed to.

[default]

; An inbound call.

exten => inbound,1,NoOp()
    same => n,Answer()
    same => n,Set(to_var=${URIENCODE(${PJSIP_HEADER(read,To)})})
    same => n,Set(custom1_var=${PJSIP_HEADER(read,Custom-Header)})
    same => n,Set(custom2_var=${PJSIP_HEADER(read,Custom-Header,2)})
    same => n,UserEvent(InboundResult,result:${IF($["${to_var}"="%22sut%22%20%3Csip%3Ainbound%40127.0.0.1%3E"]?pass:fail)})
    same => n,UserEvent(InboundResult,result:${IF($[${custom1_var}=hopethisworks]?pass:fail)})
    same => n,UserEvent(InboundResult,result:${IF($[${custom2_var}=justtotest:inbound]?pass:fail)})
    same => n,Echo()
    same => n,Hangup()

; The outbound call.

exten => outbound-recv,1,NoOp()
    same => n,Dial(PJSIP/outbound-recv,,B(default^outbound-handler^1))
    same => n,Hangup()

; The outbound call handler.

exten => outbound-handler,1,NoOp()
    same => n,Set(PJSIP_HEADER(add,Custom-Header)=adding-custom-outbound-header)
    same => n,Set(PJSIP_HEADER(add,Custom-Header)=lets-add-another-one)
    same => n,Set(custom1_var=${PJSIP_HEADER(read,Custom-Header)})
    same => n,Set(custom2_var=${PJSIP_HEADER(read,Custom-Header,2)})
    same => n,Set(to_var=${URIENCODE(${PJSIP_HEADER(read,To)})})
    same => n,UserEvent(OutboundResult,result:${IF($["${to_var}"="%22outbound-recv%22%20%3Csip%3Aoutbound-recv%40127.0.0.1%3E"]?pass:fail)})
    same => n,UserEvent(OutboundResult,result:${IF($[${custom1_var}=adding-custom-outbound-header]?pass:fail)})
    same => n,UserEvent(OutboundResult,result:${IF($[${custom2_var}=lets-add-another-one]?pass:fail)})
    same => n,Set(PJSIP_HEADER(update,Custom-Header)=change-is-good)
    same => n,Set(PJSIP_HEADER(update,Custom-Header,2)=yet-another-change)
    same => n,Set(custom1_var=${PJSIP_HEADER(read,Custom-Header)})
    same => n,Set(custom2_var=${PJSIP_HEADER(read,Custom-Header,2)})
    same => n,UserEvent(OutboundResult,result:${IF($[${custom1_var}=change-is-good]?pass:fail)})
    same => n,UserEvent(OutboundResult,result:${IF($[${custom2_var}=yet-another-change]?pass:fail)})
    same => n,Set(PJSIP_HEADER(remove,Custom-Header,2)=)
    same => n,Set(custom2_var=${PJSIP_HEADER(read,Custom-Header,2)})
    same => n,UserEvent(OutboundResult,result:${IF($[${LEN(${custom2_var})}=0]?pass:fail)})
    same => n,Set(PJSIP_HEADER(remove,Custom-Header)=)
    same => n,Set(custom1_var=${PJSIP_HEADER(read,Custom-Header)})
    same => n,UserEvent(OutboundResult,result:${IF($[${LEN(${custom1_var})}=0]?pass:fail)})
    same => n,Return()

; Pre Dial handler to modify the passed headers

exten => modify-headers,1,noOp()
	same => n,Set(PJSIP_HEADER(add,X-custom-OB-1)=epsilon)
	same => n,Set(PJSIP_HEADER(add,X-custom-OB-2)=zeta)
	same => n,Set(PJSIP_HEADER(add,X-custom-OB-3)=theta)
	same => n,Set(PJSIP_HEADER(update,X-custom-OB-2)=zeta-two)
	same => n,Set(PJSIP_HEADER(remove,X-custom-OB-3)=)
	same => n,Set(PJSIP_INHERITABLE_HEADER(remove,X-custom-3)=)
	same => n,Set(PJSIP_INHERITABLE_HEADER(update,X-custom-6)=lambda)
	same => n,Return()

; An inbound call that uses PJSIP_HEADER pass function to set headers
; that will be passed to the outbound call.

exten => inbound-pass,1,NoOp()
    same => n,Answer()
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-1)=alpha)
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-2)=beta)
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-3)=gamma)
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-4)=delta)
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-5)=sigma)
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-6)=omega)
    same => n,Set(PJSIP_INHERITABLE_HEADER(remove,X-custom-4)=)
    same => n,Set(PJSIP_INHERITABLE_HEADER(update,X-custom-5)=kappa)
    same => n,Dial(PJSIP/outbound-pass,,b(default^modify-headers^1))
    same => n,Echo()
    same => n,Hangup()

exten => inbound-pass-local,1,noOp()
    same => n,Answer()
    same => n,Dial(Local/inbound-pass@default,,)
	same => n,Hangup()

exten => inbound-pass-2,1,NoOp()
    same => n,Dial(PJSIP/outbound-pass,,b(default^modify-headers^1))
    same => n,Echo()
    same => n,Hangup()

exten => inbound-pass-local-2-extra,1,noOp()
    same => n,Answer()
    same => n,Dial(Local/inbound-pass-2@default,,)
	same => n,Hangup()

exten => inbound-pass-local-2,1,noOp()
    same => n,Answer()
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-1)=alpha)
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-2)=beta)
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-3)=gamma)
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-4)=delta)
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-5)=sigma)
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-6)=omega)
    same => n,Set(PJSIP_INHERITABLE_HEADER(remove,X-custom-4)=)
    same => n,Set(PJSIP_INHERITABLE_HEADER(update,X-custom-5)=kappa)
    same => n,Dial(Local/inbound-pass-local-2-extra@default,,)
	same => n,Hangup()

exten => inbound-pass-numbered,1,NoOp()
    same => n,Answer()
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-numbered)=one)
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-numbered)=two)
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-numbered)=tres)
    same => n,Set(PJSIP_INHERITABLE_HEADER(add,X-custom-numbered)=four)
    same => n,Set(PJSIP_INHERITABLE_HEADER(update,X-custom-numbered,3)=three)
    same => n,Dial(PJSIP/outbound-pass-numbered,,)
    same => n,Echo()
    same => n,Hangup()
