---
testinfo:
    summary:
        'Test advanced codec negotiation in a call between two parties
        with 3 common codecs but the order is chosen from the SDP'
    description: |
        'Two PJSIP endpoints are configured to support many codecs. 
        Alice client is configured with Opus as additional codec.
        All endpoints share the same codec settings in pjsip.conf, but the order is different from Alice's INVITE
        Alice calls Bob with g722,alaw,ulaw. In pjsip.conf the order is g722,ulaw,alaw.
        The common codecs are g722,pcma,pcmu in that order.
        Asterisk should not transcode in this case as the parties share at least one common codec.'

properties:
    dependencies:
        - python: 'twisted'
        - python: 'starpy'
        - asterisk: 'app_dial'
        - asterisk: 'res_pjsip'
        - sipp:
              version: 'v3.6.0'
    tags:
        - pjsip

test-modules:
    add-test-to-search-path: 'True'
    test-object:
        config-section: test-case-config
        typename: 'sipp.SIPpTestCase'

test-case-config:
    memcheck-delay-stop: 7
    # connect-ami: 'False'
    fail-on-any: false
    test-iterations:
        # First iteration
        -
            scenarios:
                # Bob receives call from Alice
                - {'key-args':
                       {'scenario': 'bob.xml', '-p': '5060', '-i': '127.0.0.3',
                        '-s': 'alice', '-timeout': '20s', '-mi': '127.0.0.3'
                       },
                   'ordered-args':
                       ['-timeout_error', '-key', 'custom_media_port', '6004']}
                # Alice calls Bob
                - {'key-args':
                       {'scenario': 'alice.xml', '-p': '5060',
                        '-i': '127.0.0.2', '-s': 'bob', '-timeout': '20s',
                        '-mi': '127.0.0.2'},
                   'ordered-args':
                       ['-timeout_error', '-key', 'custom_media_port', '6004']}
