testinfo:
    summary: "Caller initiated attended transfer to a dialplan application."
    description: |
        "Alice calls Bob via extension '101' and Bob answers. Alice places Bob
         on hold and begins an attended transfer by making another call to the
         Echo() application via extension 'echo'. Alice then completes the
         attended transfer to put Bob into the Echo() application.

         This test verifies that a callee channel can be transferred to a
         dialplan application via an attended transfer initiated by the
         caller."

test-modules:
    test-object:
        config-section: test-object-config
        typename: 'test_case.TestCaseModule'
    modules:
        -
            config-section: 'pjsua-config'
            typename: 'phones.PjsuaPhoneController'
        -
            config-section: pluggable-config
            typename: 'pluggable_modules.EventActionModule'

test-object-config:
    connect-ami: True

pjsua-config:
    transports:
        -
            name: 'local-ipv4-1'
            bind: '127.0.0.1'
            bindport: '5061'
        -
            name: 'local-ipv4-2'
            bind: '127.0.0.1'
            bindport: '5062'
    accounts:
        -
            name: 'alice'
            username: 'alice'
            domain: '127.0.0.1'
            transport: 'local-ipv4-1'
        -
            name: 'bob'
            username: 'bob'
            domain: '127.0.0.1'
            transport: 'local-ipv4-2'

pluggable-config:
    # Ensure our pjsua phones are ready. Then alice calls bob via exten 101.
    -
        ami-events:
            conditions:
                match:
                    Event: 'UserEvent'
                    UserEvent: 'PJsuaPhonesReady'
            count: 1
        pjsua_phone:
            action: 'call'
            pjsua_account: 'alice'
            call_uri: 'sip:101@127.0.0.1'
    # Ensure alice and bob are in a bridge. Then alice places bob on hold.
    -
        ami-events:
            conditions:
                match:
                    Event: 'BridgeEnter'
                    BridgeNumChannels: '2'
            count: 1
        pjsua_phone:
            action: 'hold'
            pjsua_account: 'alice'
    # Ensure MOH starts on bob's channel. Then alice calls echo to enter the
    # Echo application.
    -
        ami-events:
            conditions:
                match:
                    Event: 'MusicOnHoldStart'
                    Channel: 'PJSIP/bob-.*'
            count: 1
        pjsua_phone:
            action: 'call'
            pjsua_account: 'alice'
            call_uri: 'sip:echo@127.0.0.1'
    # Ensure alice enters the Echo application. Then transfer bob to the Echo
    # application.
    -
        ami-events:
            conditions:
                match:
                    Event: 'Newexten'
                    Channel: 'PJSIP/alice-.*'
                    Application: 'Echo'
            count: 1
        pjsua_phone:
            action: 'transfer'
            pjsua_account: 'alice'
            transfer_type: 'attended'
    # Ensure the attended transfer occurs with the proper info.
    -
        ami-events:
            conditions:
                match:
                    Event: 'AttendedTransfer'
                    OrigTransfererChannel: 'PJSIP/alice-.*'
                    Result: 'Success'
                    SecondTransfererChannel: 'PJSIP/alice-.*'
                    TransfereeChannel: 'PJSIP/bob-.*'
                    DestType: 'App'
                    DestApp: 'Echo'
            count: 1
    # Ensure MOH stops on bob's channel.
    -
        ami-events:
            conditions:
                match:
                    Event: 'MusicOnHoldStop'
                    Channel: 'PJSIP/bob-.*'
            count: 1
    # Ensure bob leaves the bridge.
    -
        ami-events:
            conditions:
                match:
                    Event: 'BridgeLeave'
                    Channel: 'PJSIP/bob-.*'
            count: 1
    # Ensure alice leaves the bridge.
    -
        ami-events:
            conditions:
                match:
                    Event: 'BridgeLeave'
                    Channel: 'PJSIP/alice-.*'
            count: 1
    # Ensure bob enters the Echo application.
    -
        ami-events:
            conditions:
                match:
                    Event: 'Newexten'
                    Channel: 'PJSIP/bob-.*'
                    Application: 'Echo'
            count: 1
    # Ensure alice's second call to echo is hung up.
    -
        ami-events:
            conditions:
                match:
                    Event: 'Hangup'
                    Channel: 'PJSIP/alice-.*'
                nomatch:
                    Exten: '101'
            count: 1
    # Ensure alice's first call to bob is hung up. Then hang up bob's channel
    # and stop the test.
    -
        ami-events:
            conditions:
                match:
                    Event: 'Hangup'
                    Channel: 'PJSIP/alice-.*'
                    Exten: '101'
            count: 1
        ami-actions:
            action:
               action: 'Hangup'
               channel: '/^PJSIP/bob-.*$/'
        stop_test:

properties:
    minversion: '12.0.0'
    dependencies:
        - python : twisted
        - python : starpy
        - python : pjsua
        - asterisk : res_pjsip
    tags:
        - pjsip

